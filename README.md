# 📄 PDF-Distributor

这是一个专为个人或小微团队设计的 PDF 自动化加工与分发系统。它能够对原始 PDF 进行**栅格化处理（彻底消除文本层）**、**自适应动态水印添加**、**多渠道独立加密**，并自动同步至**百度网盘沙盒目录**。

## ✨ 核心特性

* **极致安全**：
* **栅格化压制**：通过“PDF -> 图片 -> PDF”转换，彻底防止文字被复制或搜索。
* **分权加密**：为不同分发渠道（飞书、企微、小红书）设置独立的管理员密码及打开密码。
* **网络准入**：原生适配 Outline 等 VPN 环境，支持仅监听本地回环地址（127.0.0.1），确权访问。


* **智能水印系统**：
* **任意角度旋转**：支持 -90° 至 90° 的自由倾斜。
* **自适应间距**：基于水印旋转后的物理高度（h_multiplier）计算纵向间距，确保在 A4 或手机截屏等不同比例下视觉统一。
* **透明度继承**：直接继承 PNG 图片本身的 Alpha 通道透明度，渲染更高效、兼容性更强。


* **现代化架构**：
* **uv 支持**：在 macOS 上实现秒级启动，免去手动管理虚拟环境的烦恼。
* **多架构 Docker**：完美适配 Ubuntu (ARM64/AMD64) 异构环境。



---

## 🚀 快速开始

### 1. 准备环境 (macOS 本地测试)

推荐使用 `uv` 获得最佳性能：

```bash
# 安装 uv
brew install uv

# 运行启动脚本 (脚本会自动加载 .env)
sh run.sh

```

### 2. 服务器部署 (Ubuntu VPS)

通过提供的 `setup_vps.sh` 实现一键部署：

```bash
# 赋予权限并运行
chmod +x setup_vps.sh && ./setup_vps.sh

```

---

## ⚙️ 配置文件说明

为了保证公共仓库的安全，本项目使用 `.env` 文件管理敏感信息。

### `.env` 变量定义

在根目录创建 `.env` 文件（已加入 `.gitignore`）：

```text
BAIDU_AK=你的百度AppKey
BAIDU_SK=你的百度SecretKey
APP_FOLDER=转存分享助手  # 网盘内的沙盒文件夹名
FILE_PREFIX=BLS        # 文件前缀基准

```

### 目录结构

* `PDF-Distributor.py`: 主程序代码。
* `Dockerfile`: 无后缀，定义了基于 `uv` 的极速容器构建逻辑。
* `docker-compose.yml`: 编排容器，默认仅监听 `127.0.0.1` 以配合 Outline 代理使用。
* `baidu_token.json`: 存储网盘授权后的 Token（建议本地授权后手动上传至服务器）。
* `WM.xxx.png`: 各渠道的默认水印图。

---

## 🛠️ 技术参数建议

| 参数项 | 推荐值 | 说明 |
| --- | --- | --- |
| **DPI 缩放 (Zoom)** | 2.5 | 兼顾清晰度与文件体积的最佳平衡点 |
| **图片质量 (Quality)** | 80 | 确保栅格化后无明显视觉噪点 |
| **纵向间距倍数** | 2.5 - 3.0 | 建议根据水印文字的大小进行微调 |
| **透明度设置** | N/A | 请在制作水印图片时直接调整 PNG 透明度 |

---

## ⚠️ 注意事项

1. **水印文件名**：Linux 系统区分大小写。请确保磁盘上的文件名与代码 `DEFAULT_WM` 定义完全一致（如 `WM.Feishu.png`）。
2. **百度网盘授权**：
* 首次使用需点击页面链接获取 Code。
* 授权后生成的 `baidu_token.json` 包含有效期，系统会自动尝试刷新。


3. **安全准入**：本工具默认在 Docker 模式下仅限本地访问。如需公网直连（不推荐），请修改 `docker-compose.yml` 中的 `ports` 配置。

---

## 📝 开发者备注

本项目基于 `PyMuPDF (fitz)` 开发。针对 PDF 渲染中的任意角度旋转与透明度叠加问题，已采用最优的 `show_pdf_page` 矩阵变换方案，确保了在不同操作系统下的渲染一致性。

---